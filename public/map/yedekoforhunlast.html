<html>
<head>
  <title>
    My Map
  </title>
  <!--Leaflet-->
  <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
  <script src="lib/leaflet/leaflet.js"></script>
  <script src="data/countries.geojson"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
  <style>

  .countryLabel{
    color: #ffffff;
    font-weight: bold;
    font-size: 15;
    background-color: #ba0e0e;
    border:1;
    border-color: #000000;
    border-radius:140px;
    box-shadow: 0 0px 0px;
  }

  #map{height : 100%;width :100%;}
  </style>
</head>
<body>
  <div id="map">
    <div id="turn_state">

      <input id="player" type="text" placeholder="current player"/>
      <button id="sendbutton">Send</button>
      <button id="turnbutton">Turn End</button>
    </div>

    <div align="bottom">There will be game panel here</div>
  </div>
  <script type="text/text/javascript" src="/event.js"></script>
  <!--<script src="/event.js"> </script>-->
  <script>


  var countriesLayer;
  var current_player;
  var lastClick, lastClickedTerritory;
  var firstTurn = true;
// Each territory has a territoryid, territory name, number of soldiers on it and who belongs to playerid (-1 means nobody)
function Territory (tid, tname, neighbors, infantry, ownto){
  this.tid = tid;
  this.tname = tname;
  this.neighbors = neighbors;
  this.infantry = infantry;
  this.ownto = ownto;
}


/* COUNTRY PARSING FROM GEOJSON
for (i = 0; i < countries.features.length; i++){
  var TER = new Territory(i, countries.features[i].properties.NAME, countries.features[i].properties.NEIGHBORS, 0, -1);
    console.log('var TER'+i+' = new Territory('+i+', \''+countries.features[i].properties.NAME+'\', ');
  console.log(countries.features[i].properties.NEIGHBORS);
    console.log(', 0, -1);');
}
*/

// All territories with their neighbors
var TER0 = new Territory(0, 'Venezuela',  [ 4, 1, 2 ] , 0, -1);
var TER1 = new Territory(1, 'Brazil',  [ 3, 0, 2, 13 ] , 0, -1);
var TER2 = new Territory(2, 'PERU',  [ 3, 0, 1 ] , 0, -1);
var TER3 = new Territory(3, 'Argentina',  [ 0, 2 ] , 0, -1);
var TER4 = new Territory(4, 'Mexico',  [ 6, 0, 5 ] , 0, -1);
var TER5 = new Territory(5, 'Western United States',  [ 6, 4, 11, 10 ] , 0, -1);
var TER6 = new Territory(6, 'Eastern United States',  [ 10, 7, 5 ] , 0, -1);
var TER7 = new Territory(7, 'Eastern Canada',  [ 6, 10, 40 ] , 0, -1);
var TER8 = new Territory(8, 'Alaska',  [ 9, 11, 0 ] , 0, -1);
var TER9 = new Territory(9, 'North West Territory',  [ 8, 11, 10, 40 ] , 0, -1);
var TER10 = new Territory(10, 'Ontario',  [ 6, 11, 5, 7, 9, 40 ] , 0, -1);
var TER11 = new Territory(11, 'Alberta',  [ 10, 8, 9, 5 ] , 0, -1);
var TER12 = new Territory(12, 'Egypt',  [ 19, 17, 13, 14 ] , 0, -1);
var TER13 = new Territory(13, 'North Africa',  [ 18, 1, 12, 14, 15 ] , 0, -1);
var TER14 = new Territory(14, 'East Africa',  [ 12, 17, 27, 15, 13 ] , 0, -1);
var TER15 = new Territory(15, 'Congo',  [ 13, 16, 14 ] , 0, -1);
var TER16 = new Territory(16, 'South Africa',  [ 15, 27, 14 ] , 0, -1);
var TER17 = new Territory(17, 'Middle East',  [ 12, 14, 25, 26, 20, 19 ] , 0, -1);
var TER18 = new Territory(18, 'Western Europe',  [ 13, 19, 22 ] , 0, -1);
var TER19 = new Territory(19, 'Southern Europe',  [ 12, 17, 22, 19, 20 ] , 0, -1);
var TER20 = new Territory(20, 'Ukraine',  [ 31, 26, 17, 21, 22, 19 ] , 0, -1);
var TER21 = new Territory(21, 'Scandinavia',  [ 20, 22, 24, 23 ] , 0, -1);
var TER22 = new Territory(22, 'Northern Europe',  [ 23, 21, 19, 18, 20 ] , 0, -1);
var TER23 = new Territory(23, 'Great Britain',  [ 24, 21, 22 ] , 0, -1);
var TER24 = new Territory(24, 'Iceland',  [ 40, 23, 21 ] , 0, -1);
var TER25 = new Territory(25, 'India',  [ 17, 26, 29, 28 ] , 0, -1);
var TER26 = new Territory(26, 'Afghanistan',  [ 17, 20, 31, 25, 29 ] , 0, -1);
var TER27 = new Territory(27, 'Madagascar',  [ 16, 14 ] , 0, -1);
var TER28 = new Territory(28, 'Siam',  [ 37, 25, 29 ] , 0, -1);
var TER29 = new Territory(29, 'China',  [ 26, 28, 25, 34, 31, 30 ] , 0, -1);
var TER30 = new Territory(30, 'Mongolia',  [ 29, 34, 35, 32, 36 ] , 0, -1);
var TER31 = new Territory(31, 'Ural',  [ 20, 34, 26, 29 ] , 0, -1);
var TER32 = new Territory(32, 'Kamchatka',  [ 8, 36, 35, 33, 30 ] , 0, -1);
var TER33 = new Territory(33, 'Yakutsk',  [ 35, 32, 34 ] , 0, -1);
var TER34 = new Territory(34, 'Siberia',  [ 31, 33, 35, 30, 29 ] , 0, -1);
var TER35 = new Territory(35, 'Irutsk',  [ 30, 33, 34, 32 ] , 0, -1);
var TER36 = new Territory(36, 'Japan',  [ 0, 30 ] , 0, -1);
var TER37 = new Territory(37, 'Indonesia',  [ 28, 38, 39 ] , 0, -1);
var TER38 = new Territory(38, 'New Guinea',  [ 37, 39 ] , 0, -1);
var TER39 = new Territory(39, 'Australia',  [ 37, 38 ] , 0, -1);
var TER40 = new Territory(40, 'Greenland',  [ 9, 10, 7, 24 ] , 0, -1);

var territories = [TER0,TER1,TER2,TER3,TER4,TER5,TER6,
           TER7,TER8,TER9,TER10,TER11,TER12,TER13,
           TER14,TER15,TER16,TER17,TER18,TER19,TER20,
           TER21,TER22,TER23,TER24,TER25,TER26,TER27,
           TER28,TER29,TER30,TER31,TER32,TER33,TER34,
           TER35,TER36,TER37,TER38,TER39,TER40];

let territoryCount = territories.length;
var mapTerritories = [];

/*
    function style(feature) {
        console.log(sn);
        if (sn == feature.properties.name) {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.3,
                fillColor: '#ff0000'
            };
        } else {
            return {
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.3,
                fillColor: '#666666'
            };
        }
    }
*/

  // Highlight feature function
  function getInfantry(layer)
  {

     return layer.feature.properties.ARMYCOUNT;

  }

  // Highlight feature function
  function highlightFeature(e)
  {
    var layer = e.target;
    layer.setStyle({ weight : 3, color : 'black', fillColor : 'white', fillOpacity : 0.2,});
    if(!L.Browser.ie && !L.Browser.opera)
    { layer.bringToFront(); }
  }

  // Highlighting of a territory
  function highlightTerritory(target)
  {
    var layer = target;
    layer.setStyle({ weight : 3, color : 'black', fillColor : 'white', fillOpacity : 0.2, });
    if(!L.Browser.ie && !L.Browser.opera)
    { layer.bringToFront(); }
  }

  // Reset highlighting of a territory
  function resetHighlightTerritory(target)
  {
    countriesLayer.resetStyle(target);
  }

  // reset hightlight function
  function resetHighlight(e)
  {
    countriesLayer.resetStyle(e.target);
    //mouse üzerinden gittiğinde highlightı kaldırıyor.
  }

  // zoom to feature
  function zoomToFeature(e)
  {
    //üzerine tıklandığında zoomluyor
    // map.fitBounds(e.target.getBounds());
  }

  // Highlighting of a neighbors of a territory with a territoryid
  function highlightNeighbors(tid)
  {
      for(var j = 0; j < territories[tid].neighbors.length; j++){
        highlightTerritory(mapTerritories[territories[tid].neighbors[j]]);
      }
  }

  // Resetting of heighlight of the neighbor of a territory by its territory id
  function resetHeighlightofNeighBors(tid)
  {
      for(var j = 0; j < territories[tid].neighbors.length; j++){
        resetHighlightTerritory(mapTerritories[territories[tid].neighbors[j]]);
      }
  }
  // EKLEDIM
var counter_asia = 0; // FIRST TURN AND THE OTHERS COUNTERS ADDED
var counter_south_america = 0;
var counter_north_america = 0;
var counter_africa = 0;
var counter_europe = 0;
var counter_ocenia = 0;
var first_turn_counter = 0;

  function putInfantry(layer)
  { // EKLEDIM
    var continent = layer.feature.properties.CONTINENT;

    if(firstTurn == true)
    {
        if(first_turn_counter < 20) // en basta 20  asker koyduğunu düşünürsek
        {
        layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
        first_turn_counter = first_turn_counter + 1;
        }


    }
    else
    {


      if(continent == "Asia")
      {
        if(counter_asia < 7)
        {
          layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
          counter_asia = counter_asia + 1;
        }
      }
      else if(continent == "Europe")
      {
        if(counter_europe < 5)
        {
          layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
          counter_europe = counter_europe + 1;
        }
      }
      else if(continent == "Africa")
      {
        if(counter_africa < 3)
        {
          layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
          counter_africa = counter_africa + 1;
        }
      }
      else if(continent == "Oceania")
      {
        if(counter_ocenia < 2)
        {
          layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
          counter_ocenia = counter_ocenia + 1;
        }
      }
      else if(continent == "North America")
      {
        if(counter_north_america < 5)
        {
          layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
          counter_north_america = counter_north_america + 1;
        }
      }
      else if(continent == "South America")
      {
        if(counter_south_america < 2)
        {
          layer.feature.properties.ARMYCOUNT = layer.feature.properties.ARMYCOUNT + 1;
          counter_south_america = counter_south_america + 1;
        }
      }
    }







  }

  // Highlighting of clicked territory
  function whenClicked(e)
  {
    var glayer = e.target;  // Layer corresponds to Countries/Territories
    glayer.setStyle({ weight : 3, color: 'blue', fillColor:'yellow', fillOpacity: 0.8});
    var clickedTerritory = mapTerritories.indexOf(glayer); // It checks to match it with

    // Changing label ol this territory
    //console.log(e);
    putInfantry(glayer);
    glayer.bindTooltip((getInfantry(glayer)).toString(), {permanent:true,direction:'center',className: 'countryLabel'});

    if(lastClick && lastClick != glayer)
      { resetHeighlightofNeighBors(lastClickedTerritory); }

       highlightNeighbors(clickedTerritory);
       lastClick = glayer;
       lastClickedTerritory = clickedTerritory;
//EKLEDIM
    var end_turn_button = document.getElementById('turnbutton');
    end_turn_button.addEventListener('click', function(){
      firstTurn = false; // when clicked on end turn, resets the continent army counter for deployment
      counter_asia = 0;  // and  sets firstTurn boolean as false
      counter_south_america = 0;
      counter_north_america = 0;
      counter_africa = 0;
      counter_europe = 0;
      counter_ocenia = 0;
    });
    
  }

  // On each feature function (layer = territory)
  function countriesOnEachFeature(feature, layer)
  {

    mapTerritories.push(layer); // Loading every map territory to an array to reach easly

    // layer.bindLabel(feature.properties.POP_EST.toString(),{noHide : true});
    // her bir la(country) ile işlem yapıldığında çağırılacak fonksiyon
    layer.on({mouseover : highlightFeature, mouseout : resetHighlight, click :whenClicked});

    // Initial soldier number on each territory
    //console.log("layers: ",layer);
    layer.bindTooltip(getInfantry(layer).toString(), {permanent:true,direction:'center',className: 'countryLabel'});

    // var neighbors = feature.properties.NEIGHBORS;

    //var str = JSON.stringify(neighbors);
   //
    /*layer.bindPopup(
      '<div><img src="/data/noun_103193_cc.png" alt = "image" width=50px height=100px/></div>'
    );*/



    //https://wiki.teamfortress.com/w/images/thumb/7/7b/Soldier.png/250px-Soldier.png
    //  her feature için SOVEREIGNT isimli özelliğini bastırıyor
  }

  // country color function
  // geoJsondan gelen her feature(country)i populasyonlarına göre renklendiriyor
  function getCountryColor(CONTINENT)
  {
    //console.log(popEst); <-- was for debugging
    if(CONTINENT == "Asia")
    { return 'orange';  }
    else if(CONTINENT == "Europe")
    { return 'blue'; }
    else if(CONTINENT == "Oceania")
    { return 'green'; }
    else if(CONTINENT == "North America")
    { return 'brown'; }
    else if(CONTINENT == "South America")
    { return 'yellow'; }
    else if(CONTINENT == "Africa")
    { return 'red'; }
  }

// Style of features
  function countriesStyle(feature)
  {
    return {fillColor : getCountryColor(feature.properties.CONTINENT),
      weight : 2,
      opacity : 1,
      color : 'black',
      dashArray : 3,
      fillOpacity : 0.8
    }
  }

  var map = L.map('map').setView([43.8476, 18.3564], 2); // map merkezi ve zoom değeri ayarlanıyor
  countriesLayer = L.geoJson( // leafletin fonksiyonu, geojson dosyasını
    countries, // countries variable from geoJson
    {
      style : countriesStyle, // style için üstte yazılmış olan fonsksiyonu çağırıyor
      onEachFeature : countriesOnEachFeature // her bir featureda, countriesOnEachFeature fonksiyonunu çağırıyor.
    }
  ).addTo(map);


// It is used for legends - > We can use it to add control panel or sth else
  var legend = L.control({position : 'bottomleft'}); // lejant eklemek için
  legend.onAdd = function(map)
  {
    var div = L.DomUtil.create('div','legend');
    var labels = ["Populations greater than 100000000",
    "Populations greater than 50000000",
    "Populations equal or less than 50000000"];

    var grades = [100000001,50000001,50000000];
    div.innerHTML = '<div><b>Legend</b></div>';
    for(var i=0;i<grades.length;i++)
    {
      div.innerHTML += '<i style= "background:'
      + getCountryColor(grades[i]) + '">&nbsp;&nbsp;</i>&nbsp&nbsp;'
      + labels[i]+ '<br/>';
    }
    return div;
  }
  //legend.addTo(map);


  // marker
  /*
  var point = [43.866667, 18.416667];
  var myMarker = L.marker(point);
  myMarker.addTo(map);
  */
  //myMarker.bindTooltip("3").openTooltip();

 // var marker = new L.marker([39.5, -77.3], { opacity: 0.01 }); //opacity may be set to zero
 // marker.bindTooltip("My Label", {permanent: true, className: "my-label", offset: [0, 0] });
  //marker.addTo(map);


  // to create custom icon for markers
  /*var greenIcon = L.icon(
     {
       iconURL : 'http://leafletjs.com/docs/images/leaf-green.png',
       shadowURL : 'http://leafletjs.com/docs/images/leaf-shadow.png',
       iconSize : [38 ,95],
       shadowSize : [50,64],
       iconAnchor : [22,94],
       shadowAnchor : [4,62],
       popupAnchor : [-3,-76]
     }
   );
   var marker = L.marker(point,{icon : greenIcon}).addTo(map);*/





  //var marker = L.marker(point).addTo(map);//default marker icon

  /*var circle = L.circle( // circle marker icon
    point,
    10000,
    {
      color :'purple',
      fillColor : 'red',
      fillOpacity : 0.8
    }
  ).addTo(map);*/

  /*
  map.on('click', function(e) {
    console.log(e); // to see the values of the geojson objects in console
  });
  */
  </script>
</body>
</html>
